{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"Overview","text":"<p>Tl;DR</p> <p>A new masking method designed specifically for molecular graphs that replaces molecule parts with realistic alternatives, giving more meaningful and useful explanations for molecular property predictions than standard masking methods, which often lead to out-of-distribution samples.</p>"},{"location":"#enhancing-chemical-explainability-through-counterfactual-masking","title":"Enhancing Chemical Explainability Through Counterfactual Masking","text":"<p>\u0141ukasz Janisi\u00f3w, Marek Kocha\u0144czyk, Bartosz Zieli\u0144ski, Tomasz Danel</p> <p>Jagiellonian University, Poland</p> <p>AAAI-26 Conference Proceedings</p> <p> Paper  Code  Poster</p>"},{"location":"#motivation-molecular-masking-is-broken","title":"Motivation: Molecular Masking Is Broken","text":"<p>       When atoms or bonds are naively masked (by zeroing features or deleting parts of molecule), the resulting molecules often become chemically implausible or physically impossible, producing examples that fall outside the training distribution. This out-of-distribution problem undermines the reliability of both the explanations and their evaluation metrics. Furthermore, current masking approaches inadvertently leak information about the original graph topology to the model: even when certain atoms are \u201cmasked,\u201d their structural relationships and connectivity pattern remain implicitly encoded in the modified graph.     </p>"},{"location":"#solution-counterfactual-masking-cm","title":"Solution: Counterfactual Masking (CM)","text":"Instead of zeroing features or deleting atoms, Counterfactual Masking (CM) masks by replacing important molecular fragments with chemically plausible alternatives. This enables a direct comparison between the model\u2019s prediction for the original molecule and the average prediction across valid counterfactuals (i.e., all possible alternatives). By doing so, CM: <ul> <li>Provides chemically grounded and robust explanations</li> <li>Clarifies why specific fragments drive predictions</li> </ul>"},{"location":"#evaluation-of-fragment-masking","title":"Evaluation of Fragment Masking","text":"<p>       To evaluate different masking techniques, we used the common substructure pair dataset, which contains pairs of molecules with the same core structure. In each pair, we masked the fragments that were not shared and measured the difference in the model\u2019s predictions. An ideal masking technique should completely obscure the masked fragment, resulting in identical predictions for both molecules in the pair.     </p> <p>       We found that the common masking method, feature zeroing, produces molecules that are out of distribution and, because of that, very often leads to unreliable explanations.       While Counterfactual Masking using DiffLinker or CReM produces molecules much closer to the training distribution, explanations based on them are more faithful.     </p>"},{"location":"#can-we-generate-counterfactuals","title":"Can We Generate Counterfactuals?","text":"<p>       Although originally designed for masking tasks, CM can effectively generate realistic, chemically valid counterfactual examples by ensuring that molecules stay within the data distribution. In comparison to other counterfactual generation methods, it also enables targeted, local modifications to specific fragments, which can be easily interpreted by people with a chemistry background.     </p>"},{"location":"#for-full-tables-and-results","title":"\ud83d\udcc4 For full tables and results:","text":"<p> Read the Paper</p>"},{"location":"#acknowledgements","title":"Acknowledgements","text":"<p>This study was funded by the \u201dInterpretable and Interactive Multimodal Retrieval in Drug Discovery\u201d project. The \u201dInterpretable and Interactive Multimodal Retrieval in Drug Discovery\u201d project (FENG.02.02-IP.05-0040/23) is carried out within the First Team programme of the Foundation for Polish Science co-financed by the European Union under the European Funds for Smart Economy 2021-2027 (FENG). We gratefully acknowledge Polish high-performance computing infrastructure PLGrid (HPC Center: ACK Cyfronet AGH) for providing computer facilities and support within computational grant no. PLG/2025/018272.</p>"},{"location":"#citation","title":"Citation","text":"<pre><code>@inproceedings{janisiow2026counterfactualmasking,\n   title={Enhancing Chemical Explainability Through Counterfactual Masking},\n   journal={Proceedings of the AAAI Conference on Artificial Intelligence},\n   publisher={Association for the Advancement of Artificial Intelligence (AAAI)},\n   author={Janisi{\\'o}w, {\\L}ukasz and Kocha{\\'n}czyk, Marek and Zieli{\\'n}ski, Bartosz and Danel, Tomasz},\n   year={2026}\n   }\n</code></pre>"},{"location":"#contact","title":"Contact","text":"<p>For questions, please open an issue on GitHub or contact Tomasz Danel or \u0141ukasz Janisi\u00f3w (tomasz.danel &lt;at&gt;.uj.edu.pl, lukasz.janisiow &lt;at&gt; doctoral.uj.edu.pl).</p> <p> Paper  Code  Get started</p>"},{"location":"authors/authors/","title":"Authors","text":"\u0141ukasz Janisi\u00f3w         PhD Candidate         Jagiellonian University         ELLIS PhD Student                 Marek Kocha\u0144czyk         Assistant Professor         Jagiellonian University          Bartosz Zieli\u0144ski         Associate Professor         Jagiellonian University         ELLIS Member                 Tomasz Danel         Post-Doc         Jagiellonian University         Senior ML Scientist"},{"location":"authors/authors/#contact","title":"Contact","text":"<p>For questions, please open an issue on GitHub or contact Tomasz Danel or \u0141ukasz Janisi\u00f3w (tomasz.danel &lt;at&gt;.uj.edu.pl, lukasz.janisiow &lt;at&gt; doctoral.uj.edu.pl).</p> <p> Paper  Code  Get started</p>"},{"location":"user-guide/setup/","title":"User Guide","text":"<p>The project uses Python 3.11.5. <pre><code>git clone --branch main --recurse-submodules git@github.com:gmum/counterfactual-masking.git\n\ncd counterfactual-masking/DiffLinker\n# Download the DiffLinker model checkpoint\nmkdir -p models\nwget \"https://zenodo.org/record/7121300/files/zinc_difflinker_given_anchors.ckpt?download=1\" -O models/zinc_difflinker_given_anchors.ckpt\ncd ../\n\n# Download and extract the CReM dataset (ChEMBL22)\nmkdir data\nwget \"https://www.qsar4u.com/files/cremdb/chembl22_sa2.db.gz\" -O data/chembl22_sa2.db.gz\ngunzip data/chembl22_sa2.db.gz\n\n# Libraries\npip install torch==2.5.1+cu124 --index-url \"https://download.pytorch.org/whl/cu124\"\npip install -r requirements.txt\n\n# DiffLinker\npip install -e .\n</code></pre></p>"},{"location":"user-guide/setup/#usage","title":"Usage","text":"<p>To mask selected atoms in your molecules, you can use one of the following functions: <pre><code>from source.linksGenerator import crem_fragment_replacement, diffLinker_fragment_replacement\n\noutput = diffLinker_fragment_replacement(mol: rdkit.Chem.Mol, toDelete: list[int])\noutput = crem_fragment_replacement(mol: rdkit.Chem.Mol, toDelete: list[int])\n</code></pre> - mol \u2014 the input molecule in which you want to mask a fragment. - toDelete \u2014 a list of atom indices (nodes) that should be masked.</p> <p>The output is a set of molecules where the specified atoms have been replaced according to the chosen masking strategy.</p>"},{"location":"user-guide/setup/#reproducing-the-results","title":"Reproducing the Results","text":""},{"location":"user-guide/setup/#dataset-common-substructure-pair","title":"Dataset: Common Substructure Pair","text":"<p>Note: A preprocessed and filtered version of the Common Substructure Pair dataset is included in the repository and can be found in the <code>data_pubchem</code> directory.</p>"},{"location":"user-guide/setup/#regenerate-the-dataset","title":"Regenerate the Dataset","text":"<p>To regenerate the dataset:</p> <pre><code>python -m scripts.superstructures.fetch_superstructures --output_folder data_pubchem --dataset_name common_substructure_pair_dataset\n</code></pre> <p>This script fetches superstructures from PubChem, processes them, and saves the results in the specified directory.</p>"},{"location":"user-guide/setup/#pairs-experiment","title":"Pairs Experiment","text":"<p>This experiment evaluates different masking strategies over pairs of molecules that share common substructures.</p>"},{"location":"user-guide/setup/#step-1-train-a-model","title":"Step 1: Train a Model","text":"<pre><code>python -m source.train --model_size 512 --dropout 0.3 --batch_size 64 --seed 5\n</code></pre>"},{"location":"user-guide/setup/#step-2-run-pairs-experiment","title":"Step 2: Run Pairs Experiment","text":"<ul> <li>Single anchor</li> </ul> <pre><code>python -m scripts.pairs_experiment.pairs_prediction --output_folder single_anchor_output  --model_path checkpoints/gin/model_trained_without_salts_hidden_512_dropout_0.3_seed_5.pth --pairs_dataset data_pubchem/common_substructure_pair_dataset.json --size_model 512 --same_anchors --number_of_anchors 1\n</code></pre> <ul> <li>Multiple anchors</li> </ul> <pre><code>python -m scripts.pairs_experiment.pairs_prediction --output_folder 2_or_more_anchors_output  --model_path checkpoints/gin/model_trained_without_salts_hidden_512_dropout_0.3_seed_5.pth --pairs_dataset data_pubchem/common_substructure_pair_dataset.json --size_model 512 --number_of_anchors 2 --same_anchors\n</code></pre> <ul> <li>No anchor restrictions (Both variants)</li> </ul> <pre><code>python -m scripts.pairs_experiment.pairs_prediction --output_folder no_restrictions_output  --model_path checkpoints/gin/model_trained_without_salts_hidden_512_dropout_0.3_seed_5.pth --pairs_dataset data_pubchem/common_substructure_pair_dataset.json --size_model 512 --same_anchors\n</code></pre>"},{"location":"user-guide/setup/#step-3-view-the-results","title":"Step 3: View the Results","text":"<p>Open the following notebook to visualize results: <pre><code>scripts/pairs_experiment/results_visualization_masking_evaluation.ipynb\n</code></pre></p>"},{"location":"user-guide/setup/#counterfactuals-experiment","title":"Counterfactuals Experiment","text":"<p>This experiment evaluates different counterfactual generation methods.</p>"},{"location":"user-guide/setup/#step-1-train-models","title":"Step 1: Train Models","text":"<pre><code>python -m scripts.counterfactuals_experiment.models_training\n</code></pre>"},{"location":"user-guide/setup/#step-2-run-counterfactuals-experiment","title":"Step 2: Run Counterfactuals Experiment","text":"<pre><code>python -m scripts.counterfactuals_experiment.counterfactuals_generation --model_size 512  --seed &lt;SEED&gt; --dataset &lt;DATASET&gt; --model_path &lt;MODEL_PATH&gt;\n</code></pre>"},{"location":"user-guide/setup/#parameters","title":"Parameters","text":"Argument Description Used Values <code>--model_size</code> Hidden size of the model <code>512</code> <code>--seed</code> Random seed <code>5</code>, <code>15</code>, <code>25</code> <code>--dataset</code> Name of the dataset <code>CYP3A4_Veith</code>, <code>CYP2D6_Veith</code>, <code>hERG</code> <code>--model_path</code> Path to the trained model file e.g., <code>checkpoints/gin_cyp2d6_veith/model_CYP2D6_Veith_hidden_512_dropout_0.3_seed_15.pth</code>"},{"location":"user-guide/setup/#step-3-view-the-results_1","title":"Step 3: View the Results","text":"<pre><code>python -m scripts.counterfactuals_experiment.counterfactuals_results_reader --dataset &lt;DATASET&gt;\n</code></pre>"},{"location":"user-guide/setup/#parameters_1","title":"Parameters","text":"Argument Description Used Values <code>--dataset</code> Name of the dataset <code>CYP3A4_Veith</code>, <code>CYP2D6_Veith</code>, <code>hERG</code>"},{"location":"user-guide/setup/#explainers-experiment","title":"Explainers Experiment","text":""},{"location":"user-guide/setup/#step-1-train-models_1","title":"Step 1: Train Models","text":"<p><pre><code>(cd scripts/explainers_experiment &amp;&amp; python step_01_training.py)\n</code></pre> Training parameters are defined in <code>scripts/explainers_experiment/config.yaml</code>.</p>"},{"location":"user-guide/setup/#step-2-run-explainers-experiment","title":"Step 2: Run Explainers Experiment","text":"<p><pre><code>(cd scripts/explainers_experument &amp;&amp; python step_02_masking.py)\n</code></pre> Experiment parameters are defined in <code>scripts/explainers_experiment/config.yaml</code>.</p>"},{"location":"user-guide/setup/#step-3-summmary-of-results-table-3","title":"Step 3: Summmary of results (Table 3)","text":"<pre><code>(cd scripts/explainers_experiment &amp;&amp; jupyter execute step_03_summary.ipynb)\n</code></pre>"},{"location":"user-guide/setup/#license-and-legal","title":"License and legal","text":"<p>This project is released under the MIT License.</p>"},{"location":"user-guide/setup/#contact","title":"Contact","text":"<p>For questions, please open an issue on GitHub or contact Tomasz Danel or \u0141ukasz Janisi\u00f3w (tomasz.danel &lt;at&gt;.uj.edu.pl, lukasz.janisiow &lt;at&gt; doctoral.uj.edu.pl).</p> <p> Paper  Code  Get started</p>"}]}